<!DOCTYPE html>
<html lang="{{ site.lang | default: "en-US" }}">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#157878">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    {% seo %}
    <link rel="stylesheet" href="{{ '/assets/styles.css' | relative_url }}">
  </head>
  <body>
    <div id="sidebar-overlay"></div>
    <div id="command-palette-overlay">
      <div id="command-palette">
        <input type="text" id="command-input" placeholder="Type a command or search sections...">
        <ul id="command-list"></ul>
      </div>
    </div>
    <div id="settings-modal-overlay">
      <div id="settings-modal">
        <h2>‚öôÔ∏è Settings</h2>
        <div class="setting-group">
          <label>Font Size: <span id="font-size-val">16px</span></label>
          <input type="range" id="font-size-input" min="12" max="24" value="16" style="width: 100%;">
        </div>
        <div class="setting-group">
          <label>Theme Color</label>
          <input type="color" id="theme-color-input" value="#159957" style="width: 100%; height: 40px;">
        </div>
        <div style="display: flex; gap: 10px; justify-content: flex-end;">
          <button id="reset-settings-btn" style="padding: 8px 16px; border-radius: 8px; border: 1px solid #ccc; cursor: pointer;">Reset</button>
          <button id="close-settings-btn" style="padding: 8px 16px; border-radius: 8px; background: var(--heading-color); color: white; border: none; cursor: pointer;">Close</button>
        </div>
      </div>
    </div>
    <div id="shortcuts-overlay">
      <div id="shortcuts-modal">
        <h2>‚å®Ô∏è Site Shortcuts</h2>
        <ul class="shortcut-list">
          <li><span>Focus Search</span> <code>/</code></li>
          <li><span>Command Palette</span> <code>Cmd</code> + <code>K</code></li>
          <li><span>Show this help</span> <code>?</code></li>
          <li><span>Close overlays</span> <code>Esc</code></li>
        </ul>
        <button id="close-shortcuts-btn" style="width:100%; padding: 10px; background: var(--heading-color); color: white; border: none; border-radius: 8px; cursor: pointer;">Close</button>
      </div>
    </div>
    <div id="print-shortcuts-modal">
      <button id="print-shortcuts-close">Close</button>
      <div id="print-shortcuts-content"></div>
    </div>
    <div id="progress-container">
      <div id="progress-bar"></div>
    </div>
    <div id="mobile-fab-container">
      <div id="mobile-fab-menu">
        <button id="fab-toc-btn" class="fab-action-btn">üìë Contents</button>
        <button id="fab-search-btn" class="fab-action-btn">üîç Search</button>
        <button id="fab-settings-btn" class="fab-action-btn">‚öôÔ∏è Settings</button>
      </div>
      <button id="mobile-fab-main">‚ûï</button>
    </div>
    <button id="exit-zen-btn">Exit Zen Mode</button>
    
    <div id="keyboard-visualizer">
      <div class="kb-row">
        <div class="kb-key" data-key="`">`</div>
        <div class="kb-key" data-key="1">1</div>
        <div class="kb-key" data-key="2">2</div>
        <div class="kb-key" data-key="3">3</div>
        <div class="kb-key" data-key="4">4</div>
        <div class="kb-key" data-key="5">5</div>
        <div class="kb-key" data-key="6">6</div>
        <div class="kb-key" data-key="7">7</div>
        <div class="kb-key" data-key="8">8</div>
        <div class="kb-key" data-key="9">9</div>
        <div class="kb-key" data-key="0">0</div>
        <div class="kb-key" data-key="-">-</div>
        <div class="kb-key" data-key="=">=</div>
        <div class="kb-key kb-key-wide" data-key="delete">del</div>
      </div>
      <div class="kb-row">
        <div class="kb-key kb-key-wide" data-key="tab">tab</div>
        <div class="kb-key" data-key="q">Q</div><div class="kb-key" data-key="w">W</div><div class="kb-key" data-key="e">E</div><div class="kb-key" data-key="r">R</div><div class="kb-key" data-key="t">T</div><div class="kb-key" data-key="y">Y</div><div class="kb-key" data-key="u">U</div><div class="kb-key" data-key="i">I</div><div class="kb-key" data-key="o">O</div><div class="kb-key" data-key="p">P</div><div class="kb-key" data-key="[">[</div><div class="kb-key" data-key="]">]</div><div class="kb-key" data-key="\">|</div>
      </div>
      <div class="kb-row">
        <div class="kb-key kb-key-xwide" data-key="caps">caps</div>
        <div class="kb-key" data-key="a">A</div><div class="kb-key" data-key="s">S</div><div class="kb-key" data-key="d">D</div><div class="kb-key" data-key="f">F</div><div class="kb-key" data-key="g">G</div><div class="kb-key" data-key="h">H</div><div class="kb-key" data-key="j">J</div><div class="kb-key" data-key="k">K</div><div class="kb-key" data-key="l">L</div><div class="kb-key" data-key=";">;</div><div class="kb-key" data-key="'">'</div><div class="kb-key kb-key-xwide" data-key="return">return</div>
      </div>
      <div class="kb-row">
        <div class="kb-key kb-key-xwide" data-key="shift">shift</div>
        <div class="kb-key" data-key="z">Z</div><div class="kb-key" data-key="x">X</div><div class="kb-key" data-key="c">C</div><div class="kb-key" data-key="v">V</div><div class="kb-key" data-key="b">B</div><div class="kb-key" data-key="n">N</div><div class="kb-key" data-key="m">M</div><div class="kb-key" data-key=",">,</div><div class="kb-key" data-key=".">.</div><div class="kb-key" data-key="/">/</div><div class="kb-key kb-key-xwide" data-key="shift">shift</div>
      </div>
      <div class="kb-row">
        <div class="kb-key" data-key="fn">fn</div>
        <div class="kb-key" data-key="ctrl">ctrl</div>
        <div class="kb-key" data-key="opt">opt</div>
        <div class="kb-key kb-key-wide" data-key="cmd">cmd</div>
        <div class="kb-key kb-key-space" data-key="space">space</div>
        <div class="kb-key kb-key-wide" data-key="cmd">cmd</div>
        <div class="kb-key" data-key="opt">opt</div>
        <div class="kb-key" data-key="left">‚Üê</div><div class="kb-key" data-key="up">‚Üë</div><div class="kb-key" data-key="down">‚Üì</div><div class="kb-key" data-key="right">‚Üí</div>
      </div>
    </div>

    <a id="skip-to-content" href="#content">Skip to the content.</a>

    <header class="page-header" role="banner">
      <h1 class="project-name">{{ site.title | default: site.github.repository_name }}</h1>
      <h2 class="project-tagline">{{ site.description | default: site.github.project_tagline }}</h2>
      <p id="reading-time" style="margin-top: 0.5rem; opacity: 0.9; font-size: 0.9rem; font-weight: 500;"></p>
      
      {% if site.show_downloads %}
        <a href="{{ site.github.zip_url }}" class="btn">Download .zip</a>
        <a href="{{ site.github.tar_url }}" class="btn">Download .tar.gz</a>
      {% endif %}

      <div class="controls-container">
        <div class="search-wrapper">
          <input type="text" id="search-input" placeholder="üîç Search cheat sheet..." autocomplete="off">
          <div id="search-history-dropdown"></div>
        </div>
        <button id="mobile-menu-btn">‚ò∞ Menu</button>
        <button id="print-btn">üñ®Ô∏è PDF</button>
        <button id="share-btn">üîó Share</button>
        <button id="settings-btn">‚öôÔ∏è Settings</button>
        <button id="quick-ref-btn">üÉè Quick Ref</button>
        <button id="keyboard-toggle-btn">‚å®Ô∏è Visualizer</button>
        <button id="zen-mode-toggle">üßò Zen Mode</button>
        <button id="dark-mode-toggle">üåô Dark Mode</button>
      </div>
      
      <!-- <a href="https://github.com/kamalsoft/macOS-cheat-sheet" class="btn">View on GitHub</a> -->
    </header>

    <main id="content" class="main-content" role="main">
      <div class="page-layout">
        <aside id="toc-sidebar" class="toc-sidebar">
          <div class="favorites-section">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <h3>‚≠ê Favorites</h3>
              <button id="export-favorites-btn" title="Export Favorites to JSON" style="background:none; border:none; cursor:pointer; font-size:1.2rem;">üì•</button>
            </div>
            <ul id="favorites-list"><li class="favorites-placeholder">Click stars to bookmark sections</li></ul>
          </div>
          <div class="toc-controls">
            <span style="font-size: 0.85rem; font-weight: bold; color: var(--heading-color); text-transform: uppercase;">Contents</span>
            <button id="toc-toggle-btn">Collapse All</button>
          </div>
          <ul id="toc-list"></ul>
        </aside>
        <div class="page-content">
          {{ content }}
        </div>
      </div>

      <footer class="site-footer">
        <div class="footer-legal">
          <p><strong>Idea & Concept:</strong> Kamalesh &nbsp;|&nbsp; <strong>Copyright:</strong> &copy; 2026 Kamalesh. All Rights Reserved.</p>
          <p class="disclaimer">Disclaimer: This guide is not affiliated with, endorsed by, or sponsored by Apple Inc. macOS, Mac, and Apple Silicon are trademarks of Apple Inc. The information provided is for educational purposes only. Use at your own risk.</p>
        </div>
        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.</span>
        <span class="site-footer-credits" style="display: block; margin-top: 10px; opacity: 0.8;">Last Updated: {{ site.time | date: "%B %d, %Y" }}</span>
      </footer>
    </main>

    <button id="back-to-top" aria-label="Back to Top">‚Üë</button>
    
    <!-- Back to Top Button Script -->
    <script>
      // Scroll Progress Bar Logic
      window.addEventListener('scroll', () => {
        const winScroll = document.body.scrollTop || document.documentElement.scrollTop;
        const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
        const scrolled = (winScroll / height) * 100;
        document.getElementById("progress-bar").style.width = scrolled + "%";
      });

      // Back to Top Button Logic
      const backToTopBtn = document.getElementById('back-to-top');
      
      window.addEventListener('scroll', () => {
        if (window.scrollY > 300) {
          backToTopBtn.classList.add('visible');
        } else {
          backToTopBtn.classList.remove('visible');
        }
      });

      backToTopBtn.addEventListener('click', () => {
        window.scrollTo({
          top: 0,
          behavior: 'smooth'
        });
      });

      // Smooth scroll for anchor links
      document.querySelectorAll('a[href^="#"]').forEach(anchor => {
          anchor.addEventListener('click', function (e) {
              e.preventDefault();
              document.querySelector(this.getAttribute('href')).scrollIntoView({
                  behavior: 'smooth'
              });
          });
      });
    </script>

    <!-- Dark Mode & Search Script -->
    <script>
      // Dark Mode Logic
      const toggleBtn = document.getElementById('dark-mode-toggle');
      const html = document.documentElement;
      
      // Check saved preference
      if (localStorage.getItem('theme') === 'dark') {
        html.setAttribute('data-theme', 'dark');
        toggleBtn.textContent = '‚òÄÔ∏è Light Mode';
      }

      toggleBtn.addEventListener('click', () => {
        if (html.getAttribute('data-theme') === 'dark') {
          html.removeAttribute('data-theme');
          localStorage.setItem('theme', 'light');
          toggleBtn.textContent = 'üåô Dark Mode';
        } else {
          html.setAttribute('data-theme', 'dark');
          localStorage.setItem('theme', 'dark');
          toggleBtn.textContent = '‚òÄÔ∏è Light Mode';
        }
      });

      // Search Logic
      const searchInput = document.getElementById('search-input');
      const mainContent = document.querySelector('.page-content');
      const historyDropdown = document.getElementById('search-history-dropdown');
      let searchHistory = JSON.parse(localStorage.getItem('search_history')) || [];
      
      // Wrap content in sections for filtering
      // We assume sections start with H2
      const children = Array.from(mainContent.children);
      let currentWrapper = null;

      children.forEach(child => {
        if (child.tagName === 'H2') {
          currentWrapper = document.createElement('div');
          currentWrapper.className = 'searchable-section';
          mainContent.insertBefore(currentWrapper, child);
          currentWrapper.appendChild(child);
        } else if (currentWrapper && child.tagName !== 'FOOTER') {
          currentWrapper.appendChild(child);
        }
      });

      searchInput.addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        document.querySelectorAll('.searchable-section').forEach(section => {
          const text = section.innerText.toLowerCase();
          section.style.display = text.includes(term) ? '' : 'none';
        });
      });

      // Search History Logic
      function renderSearchHistory() {
        historyDropdown.innerHTML = '';
        if (searchHistory.length === 0) return;
        
        searchHistory.forEach(term => {
          const div = document.createElement('div');
          div.className = 'history-item';
          div.textContent = 'üïí ' + term;
          div.addEventListener('mousedown', (e) => { // mousedown fires before blur
            e.preventDefault();
            searchInput.value = term;
            searchInput.dispatchEvent(new Event('input'));
            historyDropdown.classList.remove('visible');
          });
          historyDropdown.appendChild(div);
        });
      }

      function saveSearchTerm(term) {
        if (!term || term.length < 2) return;
        searchHistory = searchHistory.filter(t => t !== term);
        searchHistory.unshift(term);
        if (searchHistory.length > 5) searchHistory.pop();
        localStorage.setItem('search_history', JSON.stringify(searchHistory));
      }

      searchInput.addEventListener('focus', () => {
        renderSearchHistory();
        if (searchHistory.length > 0) historyDropdown.classList.add('visible');
      });

      searchInput.addEventListener('blur', () => {
        historyDropdown.classList.remove('visible');
        saveSearchTerm(searchInput.value);
      });

      searchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          saveSearchTerm(searchInput.value);
          historyDropdown.classList.remove('visible');
          searchInput.blur();
        }
      });

      // Keyboard Shortcut to Focus Search
      document.addEventListener('keydown', (e) => {
        if (e.key === '/' && document.activeElement !== searchInput) {
          e.preventDefault();
          searchInput.focus();
        }
      });

      // Zen Mode Logic
      const zenToggle = document.getElementById('zen-mode-toggle');
      const exitZenBtn = document.getElementById('exit-zen-btn');
      const quickRefBtn = document.getElementById('quick-ref-btn');
      
      function toggleZenMode() {
        document.body.classList.toggle('zen-mode');
        document.body.classList.remove('quick-ref-mode'); // Ensure mutually exclusive
      }

      function toggleQuickRefMode() {
        document.body.classList.toggle('quick-ref-mode');
        document.body.classList.remove('zen-mode'); // Ensure mutually exclusive
        if (document.body.classList.contains('quick-ref-mode')) {
          exitZenBtn.textContent = 'Exit Quick Ref';
        } else {
          exitZenBtn.textContent = 'Exit Zen Mode';
        }
      }

      zenToggle.addEventListener('click', toggleZenMode);
      quickRefBtn.addEventListener('click', toggleQuickRefMode);
      
      exitZenBtn.addEventListener('click', () => {
        document.body.classList.remove('zen-mode');
        document.body.classList.remove('quick-ref-mode');
      });
      
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          if (document.body.classList.contains('zen-mode')) toggleZenMode();
          if (document.body.classList.contains('quick-ref-mode')) toggleQuickRefMode();
        }
      });

      // Share Button Logic
      const shareBtn = document.getElementById('share-btn');
      shareBtn.addEventListener('click', () => {
        const activeLink = document.querySelector('.toc-sidebar a.active');
        let url = window.location.href.split('#')[0];
        if (activeLink) {
          url += activeLink.getAttribute('href');
        }
        navigator.clipboard.writeText(url).then(() => {
          const originalText = shareBtn.textContent;
          shareBtn.textContent = '‚úÖ Copied!';
          setTimeout(() => shareBtn.textContent = originalText, 2000);
        });
      });

      // Print PDF Logic
      document.getElementById('print-btn').addEventListener('click', () => {
        window.print();
      });

      // Mobile Menu Logic
      const mobileMenuBtn = document.getElementById('mobile-menu-btn');
      const sidebar = document.getElementById('toc-sidebar');
      const overlay = document.getElementById('sidebar-overlay');

      function toggleMobileMenu() {
        sidebar.classList.toggle('active');
        overlay.classList.toggle('active');
      }

      mobileMenuBtn.addEventListener('click', toggleMobileMenu);
      overlay.addEventListener('click', toggleMobileMenu);

      // Favorites Logic
      const favoritesList = document.getElementById('favorites-list');
      let favorites = JSON.parse(localStorage.getItem('favorites')) || [];

      function updateFavoritesUI() {
        favoritesList.innerHTML = '';
        if (favorites.length === 0) {
          favoritesList.innerHTML = '<li class="favorites-placeholder">Click stars to bookmark</li>';
        } else {
          favorites.forEach(id => {
            const header = document.getElementById(id);
            if (header) {
              const li = document.createElement('li');
              const a = document.createElement('a');
              a.textContent = header.textContent.replace('‚≠ê', '').trim();
              a.href = '#' + id;
              li.appendChild(a);
              favoritesList.appendChild(li);
            }
          });
        }

        document.querySelectorAll('.favorite-btn').forEach(btn => {
          const id = btn.getAttribute('data-id');
          if (favorites.includes(id)) {
            btn.classList.add('active');
            btn.textContent = '‚òÖ';
          } else {
            btn.classList.remove('active');
            btn.textContent = '‚òÜ';
          }
        });
      }

      function toggleFavorite(id) {
        if (favorites.includes(id)) {
          favorites = favorites.filter(fav => fav !== id);
        } else {
          favorites.push(id);
        }
        localStorage.setItem('favorites', JSON.stringify(favorites));
        updateFavoritesUI();
      }

      // Export Favorites Logic
      document.getElementById('export-favorites-btn').addEventListener('click', () => {
        if (favorites.length === 0) {
          alert('No favorites to export!');
          return;
        }
        
        const exportData = favorites.map(id => {
          const header = document.getElementById(id);
          return {
            id: id,
            title: header ? header.textContent.replace('‚≠ê', '').replace('‚òÜ', '').trim() : id,
            url: window.location.href.split('#')[0] + '#' + id
          };
        });

        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportData, null, 2));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "macos_cheatsheet_favorites.json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
      });

      // Command Palette Logic (Cmd+K)
      const cmdPaletteOverlay = document.getElementById('command-palette-overlay');
      const cmdInput = document.getElementById('command-input');
      const cmdList = document.getElementById('command-list');
      let cmdItems = [];
      let cmdHistory = JSON.parse(localStorage.getItem('cmd_history')) || [];

      function openCommandPalette() {
        cmdPaletteOverlay.style.display = 'flex';
        cmdInput.value = '';
        cmdInput.focus();
        populateCommandList();
      }

      function closeCommandPalette() {
        cmdPaletteOverlay.style.display = 'none';
      }

      function populateCommandList() {
        cmdList.innerHTML = '';
        cmdItems = [];

        // Add History
        if (cmdHistory.length > 0) {
          const historyHeader = document.createElement('li');
          historyHeader.innerHTML = '<strong>üïí Recently Visited</strong>';
          historyHeader.style.pointerEvents = 'none';
          historyHeader.style.background = 'transparent';
          cmdList.appendChild(historyHeader);

          cmdHistory.forEach(item => {
            createCmdItem(item.title, () => {
              window.location.hash = item.id;
              addToHistory(item.id, item.title);
            }, 'History', true);
          });
        }

        // Add Actions
        const actions = [
          { title: 'Toggle Dark Mode', action: () => toggleBtn.click(), shortcut: 'Theme' },
          { title: 'Toggle Zen Mode', action: () => toggleZenMode(), shortcut: 'Zen' },
          { title: 'Print to PDF', action: () => window.print(), shortcut: 'Print' },
          { title: 'Export Favorites', action: () => document.getElementById('export-favorites-btn').click(), shortcut: 'Export' }
        ];

        actions.forEach(item => {
          createCmdItem(item.title, item.action, item.shortcut);
        });

        // Add Sections
        document.querySelectorAll('.page-content h2').forEach(header => {
          if (header.id) {
            const title = header.textContent.replace('‚≠ê', '').replace('‚òÜ', '').trim();
            createCmdItem('Go to: ' + title, () => {
              window.location.hash = header.id;
              addToHistory(header.id, title);
            }, 'Section');
          }
        });
      }

      function createCmdItem(text, action, shortcut, isHistory = false) {
        const li = document.createElement('li');
        li.innerHTML = `<span>${text}</span>${shortcut ? `<span class="cmd-shortcut">${shortcut}</span>` : ''}`;
        li.addEventListener('click', () => {
          action();
          closeCommandPalette();
        });
        cmdList.appendChild(li);
        if (!isHistory) {
          cmdItems.push({ element: li, text: text.toLowerCase() });
        }
      }

      // Filter List
      cmdInput.addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        cmdItems.forEach(item => {
          item.element.style.display = item.text.includes(term) ? 'flex' : 'none';
        });
      });

      // Keyboard Shortcuts
      document.addEventListener('keydown', (e) => {
        if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
          e.preventDefault();
          cmdPaletteOverlay.style.display === 'flex' ? closeCommandPalette() : openCommandPalette();
        }
        if (e.key === 'Escape' && cmdPaletteOverlay.style.display === 'flex') {
          closeCommandPalette();
        }
      });
      
      // Close on click outside
      cmdPaletteOverlay.addEventListener('click', (e) => {
        if (e.target === cmdPaletteOverlay) closeCommandPalette();
      });

      function addToHistory(id, title) {
        cmdHistory = cmdHistory.filter(item => item.id !== id);
        cmdHistory.unshift({ id, title });
        if (cmdHistory.length > 5) cmdHistory.pop();
        localStorage.setItem('cmd_history', JSON.stringify(cmdHistory));
      }

      // Settings Modal Logic
      const settingsBtn = document.getElementById('settings-btn');
      const settingsOverlay = document.getElementById('settings-modal-overlay');
      const closeSettingsBtn = document.getElementById('close-settings-btn');
      const resetSettingsBtn = document.getElementById('reset-settings-btn');
      const fontSizeInput = document.getElementById('font-size-input');
      const fontSizeVal = document.getElementById('font-size-val');
      const themeColorInput = document.getElementById('theme-color-input');

      // Load Settings
      const savedFontSize = localStorage.getItem('fontSize') || '16';
      const savedThemeColor = localStorage.getItem('themeColor') || '#159957';

      function applySettings(fontSize, themeColor) {
        document.documentElement.style.setProperty('--base-font-size', fontSize + 'px');
        document.documentElement.style.setProperty('--heading-color', themeColor);
        fontSizeInput.value = fontSize;
        fontSizeVal.textContent = fontSize + 'px';
        themeColorInput.value = themeColor;
      }

      applySettings(savedFontSize, savedThemeColor);

      settingsBtn.addEventListener('click', () => {
        settingsOverlay.style.display = 'flex';
      });

      closeSettingsBtn.addEventListener('click', () => {
        settingsOverlay.style.display = 'none';
      });
      
      settingsOverlay.addEventListener('click', (e) => {
        if (e.target === settingsOverlay) settingsOverlay.style.display = 'none';
      });

      fontSizeInput.addEventListener('input', (e) => {
        const val = e.target.value;
        fontSizeVal.textContent = val + 'px';
        document.documentElement.style.setProperty('--base-font-size', val + 'px');
        localStorage.setItem('fontSize', val);
      });

      themeColorInput.addEventListener('input', (e) => {
        const val = e.target.value;
        document.documentElement.style.setProperty('--heading-color', val);
        localStorage.setItem('themeColor', val);
      });

      resetSettingsBtn.addEventListener('click', () => {
        localStorage.removeItem('fontSize');
        localStorage.removeItem('themeColor');
        applySettings('16', '#159957');
      });

      // Shortcuts Overlay Logic
      const shortcutsOverlay = document.getElementById('shortcuts-overlay');
      const closeShortcutsBtn = document.getElementById('close-shortcuts-btn');

      document.addEventListener('keydown', (e) => {
        if (e.key === '?' && document.activeElement.tagName !== 'INPUT') {
          shortcutsOverlay.style.display = 'flex';
        }
        if (e.key === 'Escape' && shortcutsOverlay.style.display === 'flex') {
          shortcutsOverlay.style.display = 'none';
        }
      });

      closeShortcutsBtn.addEventListener('click', () => shortcutsOverlay.style.display = 'none');
      shortcutsOverlay.addEventListener('click', (e) => {
        if (e.target === shortcutsOverlay) shortcutsOverlay.style.display = 'none';
      });
    </script>

    <!-- TOC & Copy Button Script -->
    <script>
      // Generate TOC
      const tocList = document.getElementById('toc-list');
      const headers = document.querySelectorAll('.page-content h2, .page-content h3');
      let currentSublist = null;
      
      headers.forEach(header => {
        if (header.id) {
          const isH2 = header.tagName.toLowerCase() === 'h2';
          
          // Add Favorite Button (Only for H2s to keep UI clean)
          if (isH2) {
            const favBtn = document.createElement('button');
            favBtn.className = 'favorite-btn';
            favBtn.setAttribute('data-id', header.id);
            favBtn.textContent = '‚òÜ';
            favBtn.onclick = (e) => {
              e.stopPropagation();
              toggleFavorite(header.id);
            };
            header.appendChild(favBtn);
          }

          // Create List Item
          const li = document.createElement('li');
          const a = document.createElement('a');
          a.textContent = header.textContent.replace('‚≠ê', '').replace('‚òÜ', '').trim();
          a.href = '#' + header.id;
          a.addEventListener('click', () => addToHistory(header.id, a.textContent));
          li.appendChild(a);

          // Calculate Read Time for H2
          if (isH2) {
            let sectionText = '';
            let nextNode = header.nextElementSibling;
            while (nextNode && nextNode.tagName !== 'H2') {
              sectionText += nextNode.innerText + ' ';
              nextNode = nextNode.nextElementSibling;
            }
            const wordCount = sectionText.trim().split(/\s+/).length;
            const readTime = Math.ceil(wordCount / 200);
            if (readTime > 0) {
              const timeSpan = document.createElement('span');
              timeSpan.className = 'toc-read-time';
              timeSpan.textContent = `${readTime} min`;
              a.appendChild(timeSpan);
            }
          }

          if (isH2) {
            li.className = 'toc-h2-item';
            const ul = document.createElement('ul');
            ul.className = 'toc-sublist';
            li.appendChild(ul);
            currentSublist = ul;
            tocList.appendChild(li);
          } else {
            li.className = 'toc-h3-item';
            if (currentSublist) {
              currentSublist.appendChild(li);
            } else {
              tocList.appendChild(li);
            }
          }
        }
      });

      // Collapse/Expand Logic
      const tocToggleBtn = document.getElementById('toc-toggle-btn');
      let tocExpanded = true;

      tocToggleBtn.addEventListener('click', () => {
        tocExpanded = !tocExpanded;
        document.querySelectorAll('.toc-sublist').forEach(ul => {
          ul.style.display = tocExpanded ? 'block' : 'none';
        });
        tocToggleBtn.textContent = tocExpanded ? 'Collapse All' : 'Expand All';
      });

      // Initialize Favorites
      updateFavoritesUI();

      // Highlight Active TOC Item
      const observer = new IntersectionObserver(entries => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            document.querySelectorAll('.toc-sidebar a').forEach(link => link.classList.remove('active'));
            const id = entry.target.id;
            const link = document.querySelector(`.toc-sidebar a[href="#${id}"]`);
            if (link) link.classList.add('active');
          }
        });
      }, { rootMargin: '-100px 0px -66%' });

      headers.forEach(header => observer.observe(header));

      // Copy to Clipboard Buttons
      document.querySelectorAll('pre').forEach(pre => {
        const wrapper = document.createElement('div');
        wrapper.className = 'code-container';
        pre.parentNode.insertBefore(wrapper, pre);
        wrapper.appendChild(pre);
        
        const button = document.createElement('button');
        button.className = 'copy-btn';
        button.textContent = 'Copy';
        button.addEventListener('click', () => {
          const code = pre.querySelector('code') ? pre.querySelector('code').innerText : pre.innerText;
          navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'Copied!';
            setTimeout(() => button.textContent = 'Copy', 2000);
          });
        });
        wrapper.appendChild(button);
      });

      // Reading Time Estimator
      function calculateReadingTime() {
        const text = document.querySelector('.page-content').innerText;
        const wpm = 200;
        const words = text.trim().split(/\s+/).length;
        const time = Math.ceil(words / wpm);
        document.getElementById('reading-time').innerText = `üìö Estimated reading time: ${time} min`;
      }
      calculateReadingTime();

      // Mobile FAB Logic
      const fabMain = document.getElementById('mobile-fab-main');
      const fabMenu = document.getElementById('mobile-fab-menu');
      const fabToc = document.getElementById('fab-toc-btn');
      const fabSearch = document.getElementById('fab-search-btn');
      const fabSettings = document.getElementById('fab-settings-btn');

      fabMain.addEventListener('click', () => {
        fabMain.classList.toggle('active');
        fabMenu.classList.toggle('visible');
      });

      fabToc.addEventListener('click', () => {
        toggleMobileMenu();
        fabMain.click(); // Close menu
      });
      fabSearch.addEventListener('click', () => {
        document.getElementById('search-input').focus();
        fabMain.click();
      });
      fabSettings.addEventListener('click', () => {
        document.getElementById('settings-btn').click();
        fabMain.click();
      });
    </script>
    
    {% if site.google_analytics %}
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', '{{ site.google_analytics }}', 'auto');
        ga('send', 'pageview');
      </script>
    {% endif %}
  </body>
</html>
