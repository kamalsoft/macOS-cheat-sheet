<!DOCTYPE html>
<html lang="{{ site.lang | default: "en-US" }}">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#157878">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    {% seo %}
    <link rel="stylesheet" href="{{ '/assets/styles.css' | relative_url }}">
  </head>
  <body>
    <div id="sidebar-overlay"></div>
    <div id="command-palette-overlay">
      <div id="command-palette">
        <input type="text" id="command-input" placeholder="Type a command or search sections...">
        <ul id="command-list"></ul>
      </div>
    </div>
    <div id="progress-container">
      <div id="progress-bar"></div>
    </div>
    <button id="exit-zen-btn">Exit Zen Mode</button>
    <a id="skip-to-content" href="#content">Skip to the content.</a>

    <header class="page-header" role="banner">
      <h1 class="project-name">{{ site.title | default: site.github.repository_name }}</h1>
      <h2 class="project-tagline">{{ site.description | default: site.github.project_tagline }}</h2>
      <p id="reading-time" style="margin-top: 0.5rem; opacity: 0.9; font-size: 0.9rem; font-weight: 500;"></p>
      
      {% if site.show_downloads %}
        <a href="{{ site.github.zip_url }}" class="btn">Download .zip</a>
        <a href="{{ site.github.tar_url }}" class="btn">Download .tar.gz</a>
      {% endif %}

      <div class="controls-container">
        <input type="text" id="search-input" placeholder="üîç Search cheat sheet...">
        <button id="mobile-menu-btn">‚ò∞ Menu</button>
        <button id="print-btn">üñ®Ô∏è PDF</button>
        <button id="share-btn">üîó Share</button>
        <button id="zen-mode-toggle">üßò Zen Mode</button>
        <button id="dark-mode-toggle">üåô Dark Mode</button>
      </div>
      
      <!-- <a href="https://github.com/kamalsoft/macOS-cheat-sheet" class="btn">View on GitHub</a> -->
    </header>

    <main id="content" class="main-content" role="main">
      <div class="page-layout">
        <aside id="toc-sidebar" class="toc-sidebar">
          <div class="favorites-section">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <h3>‚≠ê Favorites</h3>
              <button id="export-favorites-btn" title="Export Favorites to JSON" style="background:none; border:none; cursor:pointer; font-size:1.2rem;">üì•</button>
            </div>
            <ul id="favorites-list"><li class="favorites-placeholder">Click stars to bookmark sections</li></ul>
          </div>
          <ul id="toc-list"></ul>
        </aside>
        <div class="page-content">
          {{ content }}
        </div>
      </div>

      <footer class="site-footer">
        <div class="footer-legal">
          <p><strong>Idea & Concept:</strong> Kamalesh &nbsp;|&nbsp; <strong>Copyright:</strong> &copy; 2026 Kamalesh. All Rights Reserved.</p>
          <p class="disclaimer">Disclaimer: This guide is not affiliated with, endorsed by, or sponsored by Apple Inc. macOS, Mac, and Apple Silicon are trademarks of Apple Inc. The information provided is for educational purposes only. Use at your own risk.</p>
        </div>
        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.</span>
        <span class="site-footer-credits" style="display: block; margin-top: 10px; opacity: 0.8;">Last Updated: {{ site.time | date: "%B %d, %Y" }}</span>
      </footer>
    </main>

    <button id="back-to-top" aria-label="Back to Top">‚Üë</button>
    
    <!-- Back to Top Button Script -->
    <script>
      // Scroll Progress Bar Logic
      window.addEventListener('scroll', () => {
        const winScroll = document.body.scrollTop || document.documentElement.scrollTop;
        const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
        const scrolled = (winScroll / height) * 100;
        document.getElementById("progress-bar").style.width = scrolled + "%";
      });

      // Back to Top Button Logic
      const backToTopBtn = document.getElementById('back-to-top');
      
      window.addEventListener('scroll', () => {
        if (window.scrollY > 300) {
          backToTopBtn.classList.add('visible');
        } else {
          backToTopBtn.classList.remove('visible');
        }
      });

      backToTopBtn.addEventListener('click', () => {
        window.scrollTo({
          top: 0,
          behavior: 'smooth'
        });
      });

      // Smooth scroll for anchor links
      document.querySelectorAll('a[href^="#"]').forEach(anchor => {
          anchor.addEventListener('click', function (e) {
              e.preventDefault();
              document.querySelector(this.getAttribute('href')).scrollIntoView({
                  behavior: 'smooth'
              });
          });
      });
    </script>

    <!-- Dark Mode & Search Script -->
    <script>
      // Dark Mode Logic
      const toggleBtn = document.getElementById('dark-mode-toggle');
      const html = document.documentElement;
      
      // Check saved preference
      if (localStorage.getItem('theme') === 'dark') {
        html.setAttribute('data-theme', 'dark');
        toggleBtn.textContent = '‚òÄÔ∏è Light Mode';
      }

      toggleBtn.addEventListener('click', () => {
        if (html.getAttribute('data-theme') === 'dark') {
          html.removeAttribute('data-theme');
          localStorage.setItem('theme', 'light');
          toggleBtn.textContent = 'üåô Dark Mode';
        } else {
          html.setAttribute('data-theme', 'dark');
          localStorage.setItem('theme', 'dark');
          toggleBtn.textContent = '‚òÄÔ∏è Light Mode';
        }
      });

      // Search Logic
      const searchInput = document.getElementById('search-input');
      const mainContent = document.querySelector('.page-content');
      
      // Wrap content in sections for filtering
      // We assume sections start with H2
      const children = Array.from(mainContent.children);
      let currentWrapper = null;

      children.forEach(child => {
        if (child.tagName === 'H2') {
          currentWrapper = document.createElement('div');
          currentWrapper.className = 'searchable-section';
          mainContent.insertBefore(currentWrapper, child);
          currentWrapper.appendChild(child);
        } else if (currentWrapper && child.tagName !== 'FOOTER') {
          currentWrapper.appendChild(child);
        }
      });

      searchInput.addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        document.querySelectorAll('.searchable-section').forEach(section => {
          const text = section.innerText.toLowerCase();
          section.style.display = text.includes(term) ? '' : 'none';
        });
      });

      // Keyboard Shortcut to Focus Search
      document.addEventListener('keydown', (e) => {
        if (e.key === '/' && document.activeElement !== searchInput) {
          e.preventDefault();
          searchInput.focus();
        }
      });

      // Zen Mode Logic
      const zenToggle = document.getElementById('zen-mode-toggle');
      const exitZenBtn = document.getElementById('exit-zen-btn');
      
      function toggleZenMode() {
        document.body.classList.toggle('zen-mode');
      }

      zenToggle.addEventListener('click', toggleZenMode);
      exitZenBtn.addEventListener('click', toggleZenMode);
      
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && document.body.classList.contains('zen-mode')) {
          toggleZenMode();
        }
      });

      // Share Button Logic
      const shareBtn = document.getElementById('share-btn');
      shareBtn.addEventListener('click', () => {
        const activeLink = document.querySelector('.toc-sidebar a.active');
        let url = window.location.href.split('#')[0];
        if (activeLink) {
          url += activeLink.getAttribute('href');
        }
        navigator.clipboard.writeText(url).then(() => {
          const originalText = shareBtn.textContent;
          shareBtn.textContent = '‚úÖ Copied!';
          setTimeout(() => shareBtn.textContent = originalText, 2000);
        });
      });

      // Print PDF Logic
      document.getElementById('print-btn').addEventListener('click', () => {
        window.print();
      });

      // Mobile Menu Logic
      const mobileMenuBtn = document.getElementById('mobile-menu-btn');
      const sidebar = document.getElementById('toc-sidebar');
      const overlay = document.getElementById('sidebar-overlay');

      function toggleMobileMenu() {
        sidebar.classList.toggle('active');
        overlay.classList.toggle('active');
      }

      mobileMenuBtn.addEventListener('click', toggleMobileMenu);
      overlay.addEventListener('click', toggleMobileMenu);

      // Favorites Logic
      const favoritesList = document.getElementById('favorites-list');
      let favorites = JSON.parse(localStorage.getItem('favorites')) || [];

      function updateFavoritesUI() {
        favoritesList.innerHTML = '';
        if (favorites.length === 0) {
          favoritesList.innerHTML = '<li class="favorites-placeholder">Click stars to bookmark</li>';
        } else {
          favorites.forEach(id => {
            const header = document.getElementById(id);
            if (header) {
              const li = document.createElement('li');
              const a = document.createElement('a');
              a.textContent = header.textContent.replace('‚≠ê', '').trim();
              a.href = '#' + id;
              li.appendChild(a);
              favoritesList.appendChild(li);
            }
          });
        }

        document.querySelectorAll('.favorite-btn').forEach(btn => {
          const id = btn.getAttribute('data-id');
          if (favorites.includes(id)) {
            btn.classList.add('active');
            btn.textContent = '‚òÖ';
          } else {
            btn.classList.remove('active');
            btn.textContent = '‚òÜ';
          }
        });
      }

      function toggleFavorite(id) {
        if (favorites.includes(id)) {
          favorites = favorites.filter(fav => fav !== id);
        } else {
          favorites.push(id);
        }
        localStorage.setItem('favorites', JSON.stringify(favorites));
        updateFavoritesUI();
      }

      // Export Favorites Logic
      document.getElementById('export-favorites-btn').addEventListener('click', () => {
        if (favorites.length === 0) {
          alert('No favorites to export!');
          return;
        }
        
        const exportData = favorites.map(id => {
          const header = document.getElementById(id);
          return {
            id: id,
            title: header ? header.textContent.replace('‚≠ê', '').replace('‚òÜ', '').trim() : id,
            url: window.location.href.split('#')[0] + '#' + id
          };
        });

        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportData, null, 2));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "macos_cheatsheet_favorites.json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
      });

      // Command Palette Logic (Cmd+K)
      const cmdPaletteOverlay = document.getElementById('command-palette-overlay');
      const cmdInput = document.getElementById('command-input');
      const cmdList = document.getElementById('command-list');
      let cmdItems = [];

      function openCommandPalette() {
        cmdPaletteOverlay.style.display = 'flex';
        cmdInput.value = '';
        cmdInput.focus();
        populateCommandList();
      }

      function closeCommandPalette() {
        cmdPaletteOverlay.style.display = 'none';
      }

      function populateCommandList() {
        cmdList.innerHTML = '';
        cmdItems = [];

        // Add Actions
        const actions = [
          { title: 'Toggle Dark Mode', action: () => toggleBtn.click(), shortcut: 'Theme' },
          { title: 'Toggle Zen Mode', action: () => toggleZenMode(), shortcut: 'Zen' },
          { title: 'Print to PDF', action: () => window.print(), shortcut: 'Print' },
          { title: 'Export Favorites', action: () => document.getElementById('export-favorites-btn').click(), shortcut: 'Export' }
        ];

        actions.forEach(item => {
          createCmdItem(item.title, item.action, item.shortcut);
        });

        // Add Sections
        document.querySelectorAll('.page-content h2').forEach(header => {
          if (header.id) {
            createCmdItem('Go to: ' + header.textContent.replace('‚≠ê', '').replace('‚òÜ', '').trim(), () => {
              window.location.hash = header.id;
            }, 'Section');
          }
        });
      }

      function createCmdItem(text, action, shortcut) {
        const li = document.createElement('li');
        li.innerHTML = `<span>${text}</span>${shortcut ? `<span class="cmd-shortcut">${shortcut}</span>` : ''}`;
        li.addEventListener('click', () => {
          action();
          closeCommandPalette();
        });
        cmdList.appendChild(li);
        cmdItems.push({ element: li, text: text.toLowerCase() });
      }

      // Filter List
      cmdInput.addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        cmdItems.forEach(item => {
          item.element.style.display = item.text.includes(term) ? 'flex' : 'none';
        });
      });

      // Keyboard Shortcuts
      document.addEventListener('keydown', (e) => {
        if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
          e.preventDefault();
          cmdPaletteOverlay.style.display === 'flex' ? closeCommandPalette() : openCommandPalette();
        }
        if (e.key === 'Escape' && cmdPaletteOverlay.style.display === 'flex') {
          closeCommandPalette();
        }
      });
      
      // Close on click outside
      cmdPaletteOverlay.addEventListener('click', (e) => {
        if (e.target === cmdPaletteOverlay) closeCommandPalette();
      });
    </script>

    <!-- TOC & Copy Button Script -->
    <script>
      // Generate TOC
      const tocList = document.getElementById('toc-list');
      const headers = document.querySelectorAll('.page-content h2');
      
      headers.forEach(header => {
        if (header.id) {
          // Add Favorite Button
          const favBtn = document.createElement('button');
          favBtn.className = 'favorite-btn';
          favBtn.setAttribute('data-id', header.id);
          favBtn.textContent = '‚òÜ';
          favBtn.onclick = (e) => {
            e.stopPropagation();
            toggleFavorite(header.id);
          };
          header.appendChild(favBtn);

          const li = document.createElement('li');
          const a = document.createElement('a');
          a.textContent = header.textContent;
          a.href = '#' + header.id;
          li.appendChild(a);
          tocList.appendChild(li);
        }
      });

      // Initialize Favorites
      updateFavoritesUI();

      // Highlight Active TOC Item
      const observer = new IntersectionObserver(entries => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            document.querySelectorAll('.toc-sidebar a').forEach(link => link.classList.remove('active'));
            const id = entry.target.id;
            const link = document.querySelector(`.toc-sidebar a[href="#${id}"]`);
            if (link) link.classList.add('active');
          }
        });
      }, { rootMargin: '-100px 0px -66%' });

      headers.forEach(header => observer.observe(header));

      // Copy to Clipboard Buttons
      document.querySelectorAll('pre').forEach(pre => {
        const wrapper = document.createElement('div');
        wrapper.className = 'code-container';
        pre.parentNode.insertBefore(wrapper, pre);
        wrapper.appendChild(pre);
        
        const button = document.createElement('button');
        button.className = 'copy-btn';
        button.textContent = 'Copy';
        button.addEventListener('click', () => {
          const code = pre.querySelector('code') ? pre.querySelector('code').innerText : pre.innerText;
          navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'Copied!';
            setTimeout(() => button.textContent = 'Copy', 2000);
          });
        });
        wrapper.appendChild(button);
      });

      // Reading Time Estimator
      function calculateReadingTime() {
        const text = document.querySelector('.page-content').innerText;
        const wpm = 200;
        const words = text.trim().split(/\s+/).length;
        const time = Math.ceil(words / wpm);
        document.getElementById('reading-time').innerText = `üìö Estimated reading time: ${time} min`;
      }
      calculateReadingTime();
    </script>
    
    {% if site.google_analytics %}
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', '{{ site.google_analytics }}', 'auto');
        ga('send', 'pageview');
      </script>
    {% endif %}
  </body>
</html>
